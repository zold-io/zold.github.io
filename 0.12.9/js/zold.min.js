/*! zold 2019-03-13 */

$.fn.reset=function(t){"use strict";var e=this,a=parseFloat(e.text());return e.text(t),a!==parseFloat(t)&&(e.css("background-color",t<a?"#EECBCA":"#E3EFCA"),setTimeout(function(){e.css("background-color","inherit")},800)),this};var delay=5e3,seen_nodes=new Set([]);function health_amount(t){"use strict";return Math.round(parseInt(t)/Math.pow(2,32),2)+"Z"}function health_flag(t){"use strict";var a=$('#health td[data-ip="'+t+'"]'),e=a.data("ip");e.match(/^[0-9\.]+$/)&&$.getJSON("https://ssl.geoplugin.net/json.gp?k=af0ad95fd7caa623&ip="+e,function(t){var e=t.geoplugin_countryCode;a.html('<img src="https://flagpedia.net/data/flags/normal/'+e.toLowerCase()+'.png" alt="'+e+'" style="width:1em;"/>')}).fail(function(){a.text("?")})}function health_update_nscore(){"use strict";var a=0,s=0;$("#health td.nscore").each(function(){var t=$(this).text();if(t.match(/^[0-9]+$/)){var e=parseInt(t);a<e&&(a+=e,s+=1)}}),a=Math.round(a/s);var e=0;$("#health td.score").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(e+=parseInt(t))}),$("#nscore").html('<span title="average">'+a+'</span>/<span title="actual">'+e+"</span>")}function health_update_cost(){"use strict";var e=0;$("#health td.cpus").each(function(){var t=$(this).text();t.match(/^[0-9]+$/)&&(e+=parseInt(t))}),$("#total_cpus").text(e);var t=$("#health td.cpus").length,a=$("#health td.cpus").length,s=.16*t*e/a;$("#total_dollars").text(s.toFixed(2))}function avg(t){"use strict";var e=0,a=0;$("#health td."+t).each(function(){var t=$(this).text();t.match(/^[0-9\.]+$/)&&(e+=parseInt(t),a+=1)});var s=0;return 0<a&&(s=e/a),s}function health_update_lag(){"use strict";var t=avg("remotes");$("#avg_remotes").text(Math.round(t));var e=avg("speed");$("#avg_speed").reset(Math.round(e)).colorize({32:"red",16:"orange",0:"green"});var a=avg("queue");$("#avg_queue").reset(a.toFixed(1)).colorize({32:"red",8:"orange",0:"green"});var s=1+Math.log(Math.log(seen_nodes.size))/Math.log(t);$("#hops").reset(s.toFixed(2));var r=s*e*(1+a);$("#lag").reset(Math.round(r)).colorize({32:"red",16:"orange",0:"green"})}function health_earnings(t,e){"use strict";var a=$('#health tr[data-addr="'+t+'"] td.earnings'),s="b2.zold.io:4096";$.ajax({url:"http://"+s+"/wallet/"+e+"/balance",timeout:4e3,success:function(t){a.html('<a href="/ledger.html?wallet='+e+'">'+health_amount(t)+"</a>"),a.attr("title",t+" zents in the wallet "+e+" (found in "+s+")")},error:function(){a.text("?"),a.attr("title","Can't fetch the wallet "+e+" from "+s)}})}function health_discover(s){"use strict";$.ajax({url:"http://"+s+"/remotes",timeout:4e3,success:function(t){0!==t.all.length?($("#head").hide(),$.each(t.all.sort(function(t){return t.host}),function(t,e){var a=e.host+":"+e.port;seen_nodes.has(a)||(seen_nodes.add(a),$("#health tbody").append('<tr data-addr="'+a+'" data-errors="0"><td class="host" style="'+(master_nodes.includes(a)?"font-weight:bold;":"")+'" title="Found at '+s+'"><a href="http://'+a+'/" class="alias">'+e.host+'</a></td><td class="port">'+e.port+'</td><td class="ping data"></td><td class="flag" data-ip="'+e.host+'"></td><td class="platform"></td><td class="cpus data"></td><td class="memory data"></td><td class="load data"></td><td class="threads data"></td><td class="processes data"></td><td class="score data"></td><td class="wallets data"></td><td class="version"></td><td class="nscore data"></td><td class="remotes data"></td><td class="history data"></td><td class="queue data"></td><td class="speed data"></td><td class="age data"></td><td class="earnings data"></td><td class="wallet data"></td></tr>'),setTimeout('health_node("'+a+'");',0),health_flag(e.host))})):$("#head").text("The list of remotes is empty!")},error:function(){$("#head").text("Failed to load the list of remotes from "+s),health_discover(random_default())}})}function mb(t){"use strict";return(t/1048576).toFixed(0)}function health_node(s){"use strict";var r=$('#health tr[data-addr="'+s+'"]'),o=parseInt(r.attr("data-errors"));if(3<o)return r.remove(),void seen_nodes.delete(s);var n=new Date;r.find("td.ping").html('<div class="spinner">&nbsp;</div> '),$.ajax({url:"http://"+s+"/",timeout:16e3,success:function(t){var e=new Date-n;r.find("td.ping").css("color","inherit").removeClass("failure"),r.find("td.ping").text(e).colorize({1e3:"red",500:"orange",0:"green"}),t.alias&&r.find("td.alias").text(t.alias),r.find("td.platform").text(t.platform),r.find("td.cpus").html("<a href='http://"+s+"/farm'>"+t.cpus+"</a>");var a=t.memory/t.total_mem*100;r.find("td.memory").attr("title",mb(t.memory)+"Mb out of "+mb(t.total_mem)+"Mb").reset(a.toFixed(0)).colorize({75:"red",50:"orange",0:"green"}),r.find("td.load").reset(t.load.toFixed(2)).colorize({8:"red",4:"orange",0:"green"}),r.find("td.threads").html("<a href='http://"+s+"/threads'>"+t.threads+"</a>"),r.find("td.processes").html("<a href='http://"+s+"/ps'>"+t.processes+"</a>"),r.find("td.score").reset(t.score.value).colorize({16:"green",4:"orange",0:"red"}),t.score.expired||t.score.strength<8||Date.parse(t.score.time)>new Date?(r.find("td.score").addClass("cross"),o+=1):r.find("td.score").removeClass("cross"),r.find("td.wallets").reset(t.wallets).colorize({256:"gray",257:"inherit"}),r.find("td.remotes").reset(t.remotes).colorize({20:"orange",8:"green",0:"red"}),r.find("td.version").html("<a href='https://github.com/"+t.repo+"'><i class='icon icon-github' style='margin-right:.3em;'/></a><span class='"+(t.version===$("#version").text()?"green":"red")+"'>"+t.version+"</span>/<span class='"+(t.protocol.toString()===$("#protocol").text()?"green":"red")+"'>"+t.protocol+"</span>"),r.find("td.nscore").html("<a href='/health.html?start="+s+"'>"+t.nscore+"</a>"),r.find("td.age").reset(t.hours_alive.toFixed(1)).colorize({1:"green",0:"red"}),r.find("td.history").reset(t.entrance.history_size).colorize({8:"green",0:"red"}),r.find("td.queue").reset(t.entrance.queue).colorize({32:"red",8:"orange",0:"green"}),r.find("td.speed").reset(Math.round(t.entrance.speed)).colorize({32:"red",16:"orange",0:"green"}),health_earnings(s,t.score.invoice.split("@")[1]),health_update_lag(),health_update_nscore(),health_update_cost(),health_discover(s),$("#total_nodes").reset(seen_nodes.size),r.data("errors",0)},error:function(t){r.find("td.ping").text("#"+t.status+"/"+o).addClass("failure"),o+=1},complete:function(){r.attr("data-errors",o),window.setTimeout(function(){health_node(s)},delay)}})}function health_check_wallet(){"use strict";var s=$("#wallet").val();$("#ledger_link").html('<a href="/ledger.html?wallet='+s+'">/ledger</a>'),$("#health tr[data-addr]").each(function(){var e=$(this).data("addr"),a=$(this).find("td.wallet"),t="http://"+e+"/wallet/"+s+"/balance";a.text("checking...").addClass("gray").removeClass("green"),a.attr("title",t),$.getJSON(t,function(t){a.html('<a href="http://'+e+"/wallet/"+s+'.txt">'+health_amount(t)+"</a>"),a.removeClass("gray red")}).fail(function(t){a.text(t.status).addClass("red")})})}function health_init(){"use strict";if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/health.html");else{var t=new URLSearchParams(window.location.search).get("start");null===t&&(t=random_default()),$("#head").html("Wait a second, we are loading the list of nodes from "+t+"..."),$.get("http://b2.zold.io:4096/version",function(t){$("#version").text(t)}),$.get("http://b2.zold.io:4096/protocol",function(t){$("#protocol").text(t)}),health_discover(t)}}function zold_amount(t){"use strict";return parseFloat(t/Math.pow(2,32)).toFixed(2)}function zold_date(t){"use strict";var e=new Date(Date.parse(t));return e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear()+" "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()}function ledger_draw(s,r,o){"use strict";var n=$("#ledger tbody");0===n.find('tr[data-digest="'+o+'"]').length&&$.ajax({url:"http://"+s+"/wallet/"+r+"/txns.json",timeout:4e3,success:function(t){n.find("tr").remove(),n.append('<tr data-digest="'+o+'"><td colspan="5">Found '+t.length+' transactions at <a href="http://'+s+"/wallet/"+r+'.txt">'+s+"/wallet/"+r+".txt</a> / <code>"+o.substring(0,8)+"</code>:</td></tr>");var e,a=0;for(a=0;a<t.length;a+=1)e=t[a],n.append("<tr><td>"+(e.amount<0?"#"+e.id:"&mdash;")+"</td><td>"+zold_date(e.date)+'</td><td class="data" style="color:'+(e.amount<0?"darkred":"darkgreen")+'">'+zold_amount(e.amount)+'</td><td><code><a href="?wallet='+e.bnf+'">'+e.bnf+"</a></code></td><td>"+e.details.replace(/([^\ ]{16})/g,"$1&shy;")+"</td></tr>")},error:function(){console.log("Failed to find "+r+" at "+s)}})}function ledger_seen(t){"use strict";return $("#copies a.host").map(function(){return $.trim($(this).text())}).get().includes(t)}function ledger_reorder(t){"use strict";for(var e,a,s=parseInt(t.find(".score").text());0<t.index()&&(e=t.prev(),!(parseInt(e.find(".score").text())>=s));)e.insertAfter(t);for(;t.index()<t.parent().find("tr").length-1&&(a=t.next(),!(parseInt(a.find(".score").text())<=s));)a.insertBefore(t)}function ledger_move(t,e){"use strict";var a=$("#copies tbody"),s=a.find('tr:has(td[data-digest="'+t.digest+'"])');0===s.length&&(s=$('<tr><td data-digest="'+t.digest+'"><code>'+t.digest.substring(0,8)+'</code></td><td class="data score">'+t.score.value+'</td><td class="data nodes">0</td><td class="data">'+zold_amount(t.balance)+'</td><td class="data">'+t.txns+'</td><td class="data">'+t.size+'</td><td class="hosts"></td></tr>'),a.append(s)),s.find("td.score").text(parseInt(s.find("td.score").text())+t.score.value),s.find("td.nodes").text(parseInt(s.find("td.nodes").text())+1);var r=s.find("td.hosts");return r.append(""===r.text()?"":"; "),e.remove(),e.removeClass("candidate"),r.append(e),ledger_reorder(s),s.index()}function ledger_fetch(a,s){"use strict";if(!ledger_seen(a)){var r=$('<span class="candidate"><a class="host" href="http://'+a+"/wallet/"+s+'.txt" data-addr="'+a+'" style="'+(master_nodes.includes(a)?"font-weight:bold":"")+'">'+a+"</a></span>");$("#copies td#candidates").append(r).append(" ");var t=(new Date).getTime();$.ajax({url:"http://"+a+"/wallet/"+s,timeout:4e3,complete:function(){r.find("a").after('<span class="ms">/'+((new Date).getTime()-t)+"ms</span>")},error:function(t,e,a){r.attr("title",t+"; "+e+"; "+a),r.removeClass("candidate").addClass("failed-candidate")},success:function(t){var e=ledger_move(t,r);$("#copies tbody td.hosts a").length<15&&$.ajax({url:"http://"+a+"/remotes",timeout:4e3,success:function(t){$.each(t.all,function(t,e){var a=e.host+":"+e.port;!ledger_seen(a)&&($("#copies a.host").length<16||master_nodes.includes(a))&&ledger_fetch(a,s)})},error:function(){r.css("color","red")}}),0===e&&ledger_draw(a,s,t.digest)}})}}function ledger_init(){"use strict";var e=new URLSearchParams(window.location.search).get("wallet");null!==e&&/^[0-9a-f]{16}$/.test(e)||(e="0000000000000000"),$("#root").val(e),master_nodes.forEach(function(t){ledger_fetch(t,e)})}var master_nodes=["b2.zold.io:4096","159.203.63.90:4096","167.99.77.100:4096","159.203.19.189:4096","138.197.140.42:4096"];function random_default(){"use strict";return master_nodes[Math.floor(Math.random()*master_nodes.length)]}function map_by_ip(s,r,o){"use strict";$.getJSON("http://www.geoplugin.net/json.gp?ip="+r,function(t){var e=parseFloat(t.geoplugin_latitude),a=parseFloat(t.geoplugin_longitude);new google.maps.Marker({position:{lat:e,lng:a},title:r+":"+o}).setMap(s)}).fail(function(){console.log("Failed to find geo-location for "+r)})}function map_by_host(a,t,s){"use strict";$.getJSON("https://api.exana.io/dns/"+t+"/a",function(t){var e=$.grep(t.answer,function(t,e){return"A"===t.type})[0].rdata;map_by_ip(a,e,s)}).fail(function(){console.log("Failed to find IP for "+t)})}function map_refresh(t,a){"use strict";$.getJSON("http://"+t+"/remotes",function(t){$.each(t.all,function(t,e){e.host.match(/^[0-9\.]+$/)?map_by_ip(a,e.host,e.port):map_by_host(a,e.host,e.port)})})}function map_init(){"use strict";if(window.location.protocol.startsWith("https"))$(location).attr("href","http://www.zold.io/map.html");else{var t=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(55.751244,37.618423),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:2});t.addListener("drag",function(){(t.getBounds().getSouthWest().lat()<-85||85<t.getBounds().getNorthEast().lat())&&t.setOptions({zoom:2,center:new google.maps.LatLng(0,0)})}),map_refresh(random_default(),t)}}